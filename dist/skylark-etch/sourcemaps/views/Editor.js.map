{"version":3,"sources":["views/Editor.js"],"names":["define","langx","_","View","etch","views","Editor","extend","initialize","this","$el","$","el","bindAll","model","bind","changeButtons","changePosition","changeEditable","events","click .etch-bold","click .etch-superscript","click .etch-subscript","click .etch-italic","click .etch-underline","click .etch-heading","click .etch-unordered-list","click .etch-justify-left","click .etch-justify-center","click .etch-justify-right","click .etch-ordered-list","click .etch-link","click .etch-image","click .etch-save","click .etch-clear-formatting","setButtonClass","editorModel","buttonClass","get","attr","set","buttons","config","buttonClasses","empty","view","length","each","button","$buttonEl","replace","append","show","hide","pos","animate","top","y","left","x","queue","wrapSelection","selectionOrRange","elString","cb","range","Range","getRangeAt","document","createElement","surroundContents","clearFormatting","e","preventDefault","execCommand","toggleBold","toggleSubscript","toggleSuperscript","toggleItalic","toggleUnderline","toggleHeading","window","getSelection","wrapper","commonAncestorContainer","parentElement","is","replaceWith","textContent","h3","urlPrompt","callback","url","prompt","test","toggleLink","startContainer","parentNode","tagName","endContainer","toggleUnorderedList","toggleOrderedList","justifyLeft","justifyCenter","justifyRight","getImage","startUploader","insertImage","models","ImageUploader","_imageCallback","image","startCropper","_savedRange","render","sel","removeAllRanges","addRange","attrs","editable","editableModel","EditableImage","insertNode","addClass","save","trigger"],"mappings":"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","file":"../../views/Editor.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-underscore/underscore\",\r\n  \"skylark-backbone/View\",\r\n  \"../etch\"\r\n],function(langx,_,View,etch) {\r\n  \r\n  return etch.views.Editor = View.extend({\r\n    initialize: function() {\r\n      this.$el = $(this.el);\r\n            \r\n      // Model attribute event listeners:\r\n      _.bindAll(this, 'changeButtons', 'changePosition', 'changeEditable', 'insertImage');\r\n      this.model.bind('change:buttons', this.changeButtons);\r\n      this.model.bind('change:position', this.changePosition);\r\n      this.model.bind('change:editable', this.changeEditable);\r\n\r\n      // Init Routines:\r\n      this.changeEditable();\r\n    },\r\n\r\n    events: {\r\n      'click .etch-bold': 'toggleBold',\r\n      'click .etch-superscript': 'toggleSuperscript',\r\n      'click .etch-subscript': 'toggleSubscript',\r\n      'click .etch-italic': 'toggleItalic',\r\n      'click .etch-underline': 'toggleUnderline',\r\n      'click .etch-heading': 'toggleHeading',\r\n      'click .etch-unordered-list': 'toggleUnorderedList',\r\n      'click .etch-justify-left': 'justifyLeft',\r\n      'click .etch-justify-center': 'justifyCenter',\r\n      'click .etch-justify-right': 'justifyRight',\r\n      'click .etch-ordered-list': 'toggleOrderedList',\r\n      'click .etch-link': 'toggleLink',\r\n      'click .etch-image': 'getImage',\r\n      'click .etch-save': 'save',\r\n      'click .etch-clear-formatting': 'clearFormatting'\r\n    },\r\n        \r\n    changeEditable: function() {\r\n      this.setButtonClass();\r\n      // Im assuming that Ill add more functionality here\r\n    },\r\n\r\n    setButtonClass: function() {\r\n      // check the button class of the element being edited and set the associated buttons on the model\r\n      var editorModel = this.model;\r\n      var buttonClass = editorModel.get('editable').attr('data-button-class') || 'default';\r\n      editorModel.set({ buttons: etch.config.buttonClasses[buttonClass] });\r\n    },\r\n\r\n    changeButtons: function() {\r\n      // render the buttons into the editor-panel\r\n      this.$el.empty();\r\n      var view = this;\r\n      var buttons = this.model.get('buttons');\r\n            \r\n      // hide editor panel if there are no buttons in it and exit early\r\n      if (!buttons.length) { $(this.el).hide(); return; }\r\n            \r\n      _.each(this.model.get('buttons'), function(button){\r\n        var $buttonEl = $('<a href=\"#\" class=\"etch-editor-button etch-'+ button +'\" title=\"'+ button.replace('-', ' ') +'\"><span></span></a>');\r\n        view.$el.append($buttonEl);\r\n      });\r\n            \r\n      $(this.el).show('fast');\r\n    },\r\n\r\n    changePosition: function() {\r\n      // animate editor-panel to new position\r\n      var pos = this.model.get('position');\r\n      this.$el.animate({'top': pos.y, 'left': pos.x}, { queue: false });\r\n    },\r\n        \r\n    wrapSelection: function(selectionOrRange, elString, cb) {\r\n      // wrap current selection with elString tag\r\n      var range = selectionOrRange === Range ? selectionOrRange : selectionOrRange.getRangeAt(0);\r\n      var el = document.createElement(elString);\r\n      range.surroundContents(el);\r\n    },\r\n        \r\n    clearFormatting: function(e) {\r\n      e.preventDefault();\r\n      document.execCommand('removeFormat', false, null);\r\n    },\r\n        \r\n    toggleBold: function(e) {\r\n      e.preventDefault();\r\n      document.execCommand('bold', false, null);\r\n    },\r\n\r\n    toggleSubscript: function(e) {\r\n      e.preventDefault();\r\n      document.execCommand('subscript', false, null);\r\n    },\r\n\r\n    toggleSuperscript: function(e) {\r\n      e.preventDefault();\r\n      document.execCommand('superscript', false, null);\r\n    },\r\n\r\n    toggleItalic: function(e) {\r\n      e.preventDefault();\r\n      document.execCommand('italic', false, null);\r\n    },\r\n\r\n    toggleUnderline: function(e) {\r\n      e.preventDefault();\r\n      document.execCommand('underline', false, null);\r\n    },\r\n        \r\n    toggleHeading: function(e) {\r\n      e.preventDefault();\r\n      var range = window.getSelection().getRangeAt(0);\r\n      var wrapper = range.commonAncestorContainer.parentElement\r\n      if ($(wrapper).is('h3')) {\r\n        $(wrapper).replaceWith(wrapper.textContent)\r\n        return;\r\n      }\r\n      var h3 = document.createElement('h3');\r\n      range.surroundContents(h3);\r\n    },\r\n\r\n    urlPrompt: function(callback) {\r\n      // This uses the default browser UI prompt to get a url.\r\n      // Override this function if you want to implement a custom UI.\r\n        \r\n      var url = prompt('Enter a url', 'http://');\r\n      \r\n      if (null === url) {\r\n          return;\r\n      }\r\n        \r\n      // Ensure a new link URL starts with http:// or https:// \r\n      // before it's added to the DOM.\r\n      //\r\n      // NOTE: This implementation will disallow relative URLs from being added\r\n      // but will make it easier for users typing external URLs.\r\n      if (/^((http|https)...)/.test(url)) {\r\n        callback(url);\r\n      } else {\r\n        callback(\"http://\" + url);\r\n      }\r\n    },\r\n    \r\n    toggleLink: function(e) {\r\n      e.preventDefault();\r\n      var range = window.getSelection().getRangeAt(0);\r\n\r\n      // are we in an anchor element?\r\n      if (range.startContainer.parentNode.tagName === 'A' || range.endContainer.parentNode.tagName === 'A') {\r\n        // unlink anchor\r\n        document.execCommand('unlink', false, null);\r\n      } else {\r\n        // promt for url and create link\r\n        this.urlPrompt(function(url) {\r\n          document.execCommand('createLink', false, url);\r\n        });\r\n      }\r\n    },\r\n\r\n    toggleUnorderedList: function(e) {\r\n      e.preventDefault();\r\n      document.execCommand('insertUnorderedList', false, null);\r\n    },\r\n\r\n    toggleOrderedList: function(e){\r\n      e.preventDefault();\r\n      document.execCommand('insertOrderedList', false, null);\r\n    },\r\n        \r\n    justifyLeft: function(e) {\r\n      e.preventDefault();\r\n      document.execCommand('justifyLeft', false, null);\r\n    },\r\n\r\n    justifyCenter: function(e) {\r\n      e.preventDefault();\r\n      document.execCommand('justifyCenter', false, null);\r\n    },\r\n\r\n    justifyRight: function(e) {\r\n      e.preventDefault();\r\n      document.execCommand('justifyRight', false, null);\r\n    },\r\n\r\n    getImage: function(e) {\r\n      e.preventDefault();\r\n\r\n      // call startUploader with callback to handle inserting it once it is uploaded/cropped\r\n      this.startUploader(this.insertImage);\r\n    },\r\n        \r\n    startUploader: function(cb) {\r\n      // initialize Image Uploader\r\n      var model = new models.ImageUploader();\r\n      var view = new views.ImageUploader({model: model});\r\n            \r\n      // stash a reference to the callback to be called after image is uploaded\r\n      model._imageCallback = function(image) {\r\n        view.startCropper(image, cb);\r\n      };\r\n\r\n\r\n      // stash reference to saved range for inserting the image once its \r\n      this._savedRange = window.getSelection().getRangeAt(0);\r\n\r\n      // insert uploader html into DOM\r\n      $('body').append(view.render().el);\r\n    },\r\n        \r\n    insertImage: function(image) {\r\n      // insert image - passed as a callback to startUploader\r\n      var sel = window.getSelection();\r\n      sel.removeAllRanges();\r\n      sel.addRange(this._savedRange);\r\n            \r\n      var attrs = {\r\n        'editable': this.model.get('editable'),\r\n        'editableModel': this.model.get('editableModel')\r\n      };\r\n            \r\n      _.extend(attrs, image);\r\n\r\n      var model = new models.EditableImage(attrs);\r\n      var view = new views.EditableImage({model: model});\r\n      this._savedRange.insertNode($(view.render().el).addClass('etch-float-left')[0]);\r\n    },\r\n        \r\n    save: function(e) {\r\n      e.preventDefault();\r\n      var editableModel = this.model.get('editableModel');\r\n      editableModel.trigger('save');\r\n    }\r\n  });\r\n  });\r\n  "]}